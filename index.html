<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>HUB Office Calendar</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0f0f13; --surface: #16161d; --surface2: #1e1e28;
    --border: #2a2a38; --text: #e8e8f0; --text-muted: #7a7a9a; --accent: #c8b8ff;
    --team-member: #f97316; --employee-off: #a78bfa; --holiday: #34d399; --half-day: #facc15;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { background: var(--bg); color: var(--text); font-family: 'DM Sans', sans-serif; min-height: 100vh; display: flex; flex-direction: column; }

  #loading-overlay { position: fixed; inset: 0; background: var(--bg); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 999; gap: 16px; }
  #loading-overlay h2 { font-family: 'DM Serif Display', serif; font-size: 1.6rem; }
  #loading-overlay h2 span { color: var(--accent); font-style: italic; }
  .spinner { width: 36px; height: 36px; border: 3px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; }
  @keyframes spin { to { transform: rotate(360deg); } }
  #loading-msg { font-size: 0.85rem; color: var(--text-muted); }

  header { display: flex; align-items: center; justify-content: space-between; padding: 18px 28px; border-bottom: 1px solid var(--border); background: var(--surface); position: sticky; top: 0; z-index: 100; gap: 12px; }
  header h1 { font-family: 'DM Serif Display', serif; font-size: 1.5rem; letter-spacing: -0.02em; white-space: nowrap; }
  header h1 span { color: var(--accent); font-style: italic; }
  .nav-controls { display: flex; align-items: center; gap: 10px; }
  .nav-btn { background: var(--surface2); border: 1px solid var(--border); color: var(--text); width: 34px; height: 34px; border-radius: 8px; cursor: pointer; font-size: 1.1rem; display: flex; align-items: center; justify-content: center; transition: background 0.15s, border-color 0.15s; }
  .nav-btn:hover { background: var(--border); border-color: var(--accent); }
  #month-label { font-family: 'DM Serif Display', serif; font-size: 1.15rem; min-width: 175px; text-align: center; }
  .today-btn { background: var(--surface2); border: 1px solid var(--border); color: var(--text-muted); padding: 5px 13px; border-radius: 8px; cursor: pointer; font-size: 0.78rem; font-family: 'DM Sans', sans-serif; transition: all 0.15s; }
  .today-btn:hover { border-color: var(--accent); color: var(--accent); }
  .add-btn { background: var(--accent); color: #0f0f13; border: none; padding: 8px 18px; border-radius: 8px; cursor: pointer; font-size: 0.85rem; font-weight: 600; font-family: 'DM Sans', sans-serif; transition: opacity 0.15s; white-space: nowrap; }
  .add-btn:hover { opacity: 0.85; }

  main { display: flex; flex: 1; overflow: hidden; }
  .sidebar { width: 234px; min-width: 234px; background: var(--surface); border-right: 1px solid var(--border); padding: 18px 14px; overflow-y: auto; }
  .sidebar h3 { font-size: 0.68rem; font-weight: 600; letter-spacing: 0.12em; text-transform: uppercase; color: var(--text-muted); margin-bottom: 10px; margin-top: 4px; }
  .office-legend { display: flex; flex-direction: column; gap: 5px; margin-bottom: 22px; }
  .legend-item { display: flex; align-items: center; gap: 8px; padding: 5px 8px; border-radius: 6px; cursor: pointer; transition: background 0.12s; user-select: none; }
  .legend-item:hover { background: var(--surface2); }
  .legend-item.hidden { opacity: 0.3; }
  .legend-dot { width: 11px; height: 11px; border-radius: 3px; flex-shrink: 0; }
  .legend-item span { font-size: 0.8rem; }
  .type-legend { display: flex; flex-direction: column; gap: 7px; margin-bottom: 22px; }
  .type-item { display: flex; align-items: flex-start; gap: 8px; padding: 2px 8px; }
  .type-dot { width: 9px; height: 9px; border-radius: 50%; flex-shrink: 0; margin-top: 4px; }
  .type-item-text { display: flex; flex-direction: column; }
  .type-item-label { font-size: 0.78rem; color: var(--text); }
  .type-item-sub { font-size: 0.67rem; color: var(--text-muted); margin-top: 1px; }

  .calendar-wrap { flex: 1; padding: 20px; overflow-y: auto; }
  .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
  .day-header { text-align: center; font-size: 0.68rem; font-weight: 600; letter-spacing: 0.1em; text-transform: uppercase; color: var(--text-muted); padding: 6px 0 10px; }
  .day-cell { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; min-height: 110px; padding: 7px; position: relative; cursor: pointer; transition: border-color 0.12s; }
  .day-cell:hover { border-color: var(--accent); }
  .day-cell.other-month { opacity: 0.28; }
  .day-cell.today { border-color: var(--accent); }
  .day-cell.today .day-num { color: var(--accent); font-weight: 700; }
  .day-num { font-size: 0.8rem; font-weight: 600; color: var(--text-muted); margin-bottom: 4px; }
  .event-chip { display: flex; align-items: center; gap: 3px; padding: 2px 5px; border-radius: 4px; font-size: 0.67rem; font-weight: 500; margin-bottom: 2px; cursor: pointer; background: rgba(255,255,255,0.055); border-left: 3px solid transparent; max-width: 100%; overflow: hidden; }
  .event-chip:hover { filter: brightness(1.25); }
  .chip-dot { width: 5px; height: 5px; border-radius: 50%; flex-shrink: 0; }
  .chip-text { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; flex: 1; }
  .chip-half { font-size: 0.55rem; background: var(--half-day); color: #000; border-radius: 3px; padding: 0 3px; font-weight: 700; flex-shrink: 0; }
  .more-events { font-size: 0.63rem; color: var(--text-muted); padding: 1px 4px; cursor: pointer; }
  .more-events:hover { color: var(--accent); }

  .saving-indicator { position: fixed; bottom: 20px; right: 20px; background: var(--surface2); border: 1px solid var(--border); border-radius: 8px; padding: 8px 14px; font-size: 0.78rem; color: var(--text-muted); display: none; align-items: center; gap: 8px; z-index: 150; }
  .saving-indicator.show { display: flex; }
  .saving-indicator.success { border-color: var(--holiday); color: var(--holiday); }
  .saving-indicator.error { border-color: #ff6b6b; color: #ff6b6b; }

  .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.72); z-index: 200; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
  .modal-overlay.open { display: flex; }
  .modal { background: var(--surface); border: 1px solid var(--border); border-radius: 16px; padding: 26px; width: 440px; max-width: 96vw; max-height: 90vh; overflow-y: auto; animation: slideUp 0.18s ease; }
  @keyframes slideUp { from { transform: translateY(14px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
  .modal h2 { font-family: 'DM Serif Display', serif; font-size: 1.25rem; margin-bottom: 18px; }
  .form-row { margin-bottom: 13px; }
  .form-row label { display: block; font-size: 0.72rem; font-weight: 600; letter-spacing: 0.08em; text-transform: uppercase; color: var(--text-muted); margin-bottom: 5px; }
  .form-row label .sub { font-weight: 400; text-transform: none; letter-spacing: 0; }
  .form-row select, .form-row input[type="date"], .form-row input[type="text"] { width: 100%; background: var(--surface2); border: 1px solid var(--border); color: var(--text); padding: 9px 11px; border-radius: 8px; font-family: 'DM Sans', sans-serif; font-size: 0.84rem; appearance: none; transition: border-color 0.15s; }
  .form-row select:focus, .form-row input:focus { outline: none; border-color: var(--accent); }
  .half-day-toggle { display: flex; align-items: center; gap: 10px; padding: 9px 11px; background: var(--surface2); border: 1px solid var(--border); border-radius: 8px; cursor: pointer; transition: border-color 0.15s; user-select: none; }
  .half-day-toggle:hover { border-color: var(--half-day); }
  .half-day-toggle.active { border-color: var(--half-day); background: rgba(250,204,21,0.08); }
  .toggle-switch { width: 32px; height: 18px; background: var(--border); border-radius: 9px; position: relative; transition: background 0.2s; flex-shrink: 0; }
  .toggle-switch::after { content: ''; position: absolute; top: 2px; left: 2px; width: 14px; height: 14px; border-radius: 50%; background: var(--text-muted); transition: transform 0.2s, background 0.2s; }
  .half-day-toggle.active .toggle-switch { background: var(--half-day); }
  .half-day-toggle.active .toggle-switch::after { transform: translateX(14px); background: #000; }
  .toggle-label { font-size: 0.83rem; color: var(--text); }
  .modal-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 18px; }
  .btn-cancel { background: var(--surface2); border: 1px solid var(--border); color: var(--text-muted); padding: 8px 17px; border-radius: 8px; cursor: pointer; font-family: 'DM Sans', sans-serif; font-size: 0.84rem; transition: all 0.15s; }
  .btn-cancel:hover { border-color: var(--text-muted); color: var(--text); }
  .btn-save { background: var(--accent); color: #0f0f13; border: none; padding: 8px 20px; border-radius: 8px; cursor: pointer; font-family: 'DM Sans', sans-serif; font-size: 0.84rem; font-weight: 600; transition: opacity 0.15s; }
  .btn-save:hover { opacity: 0.85; }
  .btn-save:disabled { opacity: 0.5; cursor: not-allowed; }
  .btn-delete { background: transparent; border: 1px solid #ff6b6b; color: #ff6b6b; padding: 8px 14px; border-radius: 8px; cursor: pointer; font-family: 'DM Sans', sans-serif; font-size: 0.84rem; transition: all 0.15s; margin-right: auto; }
  .btn-delete:hover { background: rgba(255,107,107,0.1); }
  .btn-delete:disabled { opacity: 0.5; cursor: not-allowed; }
  .day-detail-list { display: flex; flex-direction: column; gap: 8px; }
  .detail-card { background: var(--surface2); border: 1px solid var(--border); border-radius: 8px; padding: 10px 12px; border-left: 4px solid transparent; display: flex; align-items: center; justify-content: space-between; gap: 8px; }
  .detail-info { flex: 1; }
  .detail-name { font-size: 0.88rem; font-weight: 500; display: flex; align-items: center; gap: 6px; flex-wrap: wrap; }
  .detail-half { font-size: 0.6rem; background: var(--half-day); color: #000; border-radius: 3px; padding: 1px 5px; font-weight: 700; }
  .detail-meta { font-size: 0.73rem; color: var(--text-muted); margin-top: 2px; }
  .detail-edit-btn { background: none; border: 1px solid var(--border); color: var(--text-muted); padding: 4px 10px; border-radius: 6px; cursor: pointer; font-size: 0.73rem; font-family: 'DM Sans', sans-serif; transition: all 0.12s; flex-shrink: 0; }
  .detail-edit-btn:hover { border-color: var(--accent); color: var(--accent); }
  .no-events { color: var(--text-muted); font-size: 0.85rem; text-align: center; padding: 20px 0; }

  @media (max-width: 768px) {
    .sidebar { display: none; }
    header { padding: 12px 14px; }
    .calendar-wrap { padding: 10px; }
    .day-cell { min-height: 80px; }
  }
</style>
</head>
<body>

<div id="loading-overlay">
  <h2>HUB <span>Office Calendar</span></h2>
  <div class="spinner"></div>
  <div id="loading-msg">Loading calendarâ€¦</div>
</div>

<header>
  <h1>HUB <span>Office Calendar</span></h1>
  <div class="nav-controls">
    <button class="nav-btn" id="prev-btn">&#8249;</button>
    <span id="month-label"></span>
    <button class="nav-btn" id="next-btn">&#8250;</button>
    <button class="today-btn" id="today-btn">Today</button>
  </div>
  <button class="add-btn" id="add-entry-btn">+ Add Entry</button>
</header>

<main>
  <aside class="sidebar">
    <h3>Offices</h3>
    <div class="office-legend" id="office-legend"></div>
    <h3>Entry Types</h3>
    <div class="type-legend">
      <div class="type-item">
        <div class="type-dot" style="background:var(--team-member)"></div>
        <div class="type-item-text">
          <span class="type-item-label">Team Member Off</span>
          <span class="type-item-sub">OS Team Member</span>
        </div>
      </div>
      <div class="type-item">
        <div class="type-dot" style="background:var(--employee-off)"></div>
        <div class="type-item-text">
          <span class="type-item-label">Employee Off</span>
          <span class="type-item-sub">Personal / Commercial Lines</span>
        </div>
      </div>
      <div class="type-item">
        <div class="type-dot" style="background:var(--holiday)"></div>
        <div class="type-item-text"><span class="type-item-label">Holiday / Stat Day</span></div>
      </div>
      <div class="type-item">
        <div class="type-dot" style="background:var(--half-day)"></div>
        <div class="type-item-text">
          <span class="type-item-label">Â½ Half Day</span>
          <span class="type-item-sub">Add-on flag for any entry</span>
        </div>
      </div>
    </div>
  </aside>

  <div class="calendar-wrap">
    <div class="calendar-grid" id="calendar-grid">
      <div class="day-header">Sun</div>
      <div class="day-header">Mon</div>
      <div class="day-header">Tue</div>
      <div class="day-header">Wed</div>
      <div class="day-header">Thu</div>
      <div class="day-header">Fri</div>
      <div class="day-header">Sat</div>
    </div>
  </div>
</main>

<div class="modal-overlay" id="event-modal">
  <div class="modal">
    <h2 id="modal-title">Add Entry</h2>
    <div class="form-row">
      <label>Entry Type</label>
      <select id="entry-type">
        <option value="team-member">Team Member Off (OS Team Member)</option>
        <option value="employee-off">Employee Off (Personal / Commercial Lines)</option>
        <option value="holiday">Holiday / Stat Day</option>
      </select>
    </div>
    <div class="form-row">
      <label>Office</label>
      <select id="entry-office"></select>
    </div>
    <div class="form-row" id="name-row">
      <label id="name-label">Name</label>
      <input type="text" id="entry-name" placeholder="Type nameâ€¦">
    </div>
    <div class="form-row" id="holiday-row" style="display:none">
      <label>Holiday Name</label>
      <input type="text" id="entry-holiday-name" placeholder="e.g. Victoria Day">
    </div>
    <div class="form-row">
      <label>Date</label>
      <input type="date" id="entry-date">
    </div>
    <div class="form-row">
      <label>End Date <span class="sub">(optional â€” for multi-day)</span></label>
      <input type="date" id="entry-end-date">
    </div>
    <div class="form-row">
      <label>Half Day</label>
      <div class="half-day-toggle" id="half-day-toggle">
        <div class="toggle-switch"></div>
        <span class="toggle-label">Mark as half day</span>
      </div>
    </div>
    <div class="form-row">
      <label>Note <span class="sub">(optional)</span></label>
      <input type="text" id="entry-note" placeholder="Any detailsâ€¦">
    </div>
    <div class="modal-actions">
      <button class="btn-delete" id="delete-btn" style="display:none">ðŸ—‘ Delete Entry</button>
      <button class="btn-cancel" id="cancel-btn">Cancel</button>
      <button class="btn-save" id="save-btn">Save Entry</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="day-modal">
  <div class="modal">
    <h2 id="day-modal-title"></h2>
    <div id="day-detail-list" class="day-detail-list"></div>
    <div class="modal-actions">
      <button class="btn-cancel" id="day-close-btn">Close</button>
      <button class="btn-save" id="day-add-btn">+ Add Entry</button>
    </div>
  </div>
</div>

<div class="saving-indicator" id="saving-indicator">
  <div class="spinner" style="width:14px;height:14px;border-width:2px"></div>
  <span id="saving-msg">Savingâ€¦</span>
</div>

<script>
// â”€â”€ Proxy endpoint (Netlify function) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const PROXY = '/.netlify/functions/smartsheet';

const OFFICES = [
  { id:'markham',      name:'Markham',        color:'#ff7c7c' },
  { id:'brantford',    name:'Brantford',       color:'#ffaa55' },
  { id:'london',       name:'London',          color:'#ffd155' },
  { id:'sarnia',       name:'Sarnia',          color:'#7ddf8e' },
  { id:'chatham',      name:'Chatham',         color:'#5dc8c8' },
  { id:'barrie',       name:'Barrie',          color:'#6fa8ff' },
  { id:'oakville',     name:'Oakville',        color:'#b07dff' },
  { id:'toronto',      name:'Toronto',         color:'#ff82c8' },
  { id:'stcatharines', name:"St. Catharines",  color:'#e06bff' },
];

const TYPE_COLOR = { 'team-member':'#f97316', 'employee-off':'#a78bfa', 'holiday':'#34d399' };
const TYPE_LABEL = { 'team-member':'Team Member Off', 'employee-off':'Employee Off', 'holiday':'Holiday / Stat Day' };
const MONTHS = ['January','February','March','April','May','June','July','August','September','October','November','December'];
const REQUIRED_COLS = ['EntryType','OfficeName','EntryDate','EndDate','EntryName','HolidayName','HalfDay','Note'];

const today  = new Date();
let curYear  = today.getFullYear();
let curMonth = today.getMonth();
const todayKey = fmtDate(today.getFullYear(), today.getMonth(), today.getDate());

let events        = [];
let hiddenOffices = new Set(JSON.parse(localStorage.getItem('hub_hidden_ss') || '[]'));
let halfActive    = false;
let editingId     = null;
let dayDate       = null;
let COL           = {};

function fmtDate(y, m, d) {
  return `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
}

function eventsOn(dk) {
  return events.filter(e => {
    if (e.type !== 'holiday' && hiddenOffices.has(e.office)) return false;
    if (!e.endDate || e.endDate === e.date) return e.date === dk;
    return dk >= e.date && dk <= e.endDate;
  });
}

function showSaving(msg, type) {
  const el = document.getElementById('saving-indicator');
  el.className = 'saving-indicator show' + (type ? ' ' + type : '');
  document.getElementById('saving-msg').textContent = msg;
  if (type === 'success' || type === 'error') setTimeout(() => el.classList.remove('show'), 3000);
}

function hideLoading() {
  document.getElementById('loading-overlay').style.display = 'none';
}

// â”€â”€ API calls via Netlify proxy â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function api(action, method, body, extra) {
  let url = `${PROXY}?action=${action}`;
  if (extra) url += `&${extra}`;
  const opts = { method: method || 'GET', headers: { 'Content-Type': 'application/json' } };
  if (body) opts.body = JSON.stringify(body);
  const res  = await fetch(url, opts);
  const text = await res.text();
  try { return JSON.parse(text); } catch { return text; }
}

// â”€â”€ Sheet setup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadSheet() {
  const data = await api('sheet', 'GET');
  if (!data || data.errorCode) throw new Error(data ? data.message : 'No response from Smartsheet');

  const cols = data.columns || [];

  // Rename primary column to EntryType if needed
  const primary = cols.find(c => c.primary);
  if (primary && primary.title !== 'EntryType') {
    await api('updatecol', 'PUT', { title: 'EntryType', type: 'TEXT_NUMBER', primary: true }, `colId=${primary.id}`);
  }

  // Rename any default columns (Column2 etc) or add missing ones
  const nonPrimary = cols.filter(c => !c.primary);
  const needed = ['OfficeName','EntryDate','EndDate','EntryName','HolidayName','HalfDay','Note'];
  const colType = name =>
    (name === 'EntryDate' || name === 'EndDate') ? 'DATE' :
    name === 'HalfDay' ? 'CHECKBOX' : 'TEXT_NUMBER';

  for (let i = 0; i < needed.length; i++) {
    const name = needed[i];
    const existing = cols.find(c => c.title === name);
    if (existing) continue; // already correct

    const defaultCol = nonPrimary[i]; // try to rename a default column
    if (defaultCol && defaultCol.title.startsWith('Column')) {
      await api('updatecol', 'PUT', { title: name, type: colType(name) }, `colId=${defaultCol.id}`);
    } else {
      // Add brand new column
      await api('addcol', 'POST', [{ title: name, type: colType(name) }]);
    }
  }

  // Reload fresh with correct columns
  const fresh = await api('sheet', 'GET');
  if (!fresh || fresh.errorCode) throw new Error('Failed to reload sheet after setup');

  fresh.columns.forEach(c => { COL[c.title] = c.id; });

  // Verify we have all columns
  for (const name of REQUIRED_COLS) {
    if (!COL[name]) throw new Error(`Missing column: ${name}. Please refresh to retry setup.`);
  }

  events = (fresh.rows || [])
    .filter(row => {
      // Skip empty rows
      const get = name => {
        const cell = (row.cells || []).find(c => c.columnId === COL[name]);
        return cell ? (cell.value ?? '') : '';
      };
      return get('EntryType') || get('EntryDate');
    })
    .map(row => {
      const get = name => {
        const cell = (row.cells || []).find(c => c.columnId === COL[name]);
        return cell ? (cell.value ?? '') : '';
      };
      return {
        id:          String(row.id),
        type:        get('EntryType')   || '',
        office:      get('OfficeName')  || '',
        date:        get('EntryDate')   ? String(get('EntryDate')).split('T')[0] : '',
        endDate:     get('EndDate')     ? String(get('EndDate')).split('T')[0]   : '',
        name:        get('EntryName')   || '',
        holidayName: get('HolidayName') || '',
        halfDay:     get('HalfDay') === true || get('HalfDay') === 'true',
        note:        get('Note')        || '',
      };
    });
}

function buildCells(ev) {
  return [
    { columnId: COL['EntryType'],   value: ev.type        || '' },
    { columnId: COL['OfficeName'],  value: ev.office      || '' },
    { columnId: COL['EntryDate'],   value: ev.date        || '' },
    { columnId: COL['EndDate'],     value: ev.endDate     || '' },
    { columnId: COL['EntryName'],   value: ev.name        || '' },
    { columnId: COL['HolidayName'], value: ev.holidayName || '' },
    { columnId: COL['HalfDay'],     value: ev.halfDay     || false },
    { columnId: COL['Note'],        value: ev.note        || '' },
  ];
}

async function createRow(ev) {
  const res = await api('addrow', 'POST', [{ toBottom: true, cells: buildCells(ev) }]);
  return String(res.result[0].id);
}

async function updateRow(rowId, ev) {
  await api('updaterow', 'PUT', [{ id: Number(rowId), cells: buildCells(ev) }]);
}

async function deleteRow(rowId) {
  const res = await api('deleterow', 'DELETE', null, `rowId=${rowId}`);
  if (res && res.errorCode) throw new Error(res.message || 'Delete failed');
}

// â”€â”€ Legend â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderLegend() {
  const el = document.getElementById('office-legend');
  el.innerHTML = '';
  OFFICES.forEach(o => {
    const item = document.createElement('div');
    item.className = 'legend-item' + (hiddenOffices.has(o.id) ? ' hidden' : '');
    item.innerHTML = `<div class="legend-dot" style="background:${o.color}"></div><span>${o.name}</span>`;
    item.addEventListener('click', () => {
      hiddenOffices.has(o.id) ? hiddenOffices.delete(o.id) : hiddenOffices.add(o.id);
      localStorage.setItem('hub_hidden_ss', JSON.stringify([...hiddenOffices]));
      renderLegend(); renderCalendar();
    });
    el.appendChild(item);
  });
}

// â”€â”€ Calendar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderCalendar() {
  const grid = document.getElementById('calendar-grid');
  grid.querySelectorAll('.day-cell').forEach(c => c.remove());
  document.getElementById('month-label').textContent = `${MONTHS[curMonth]} ${curYear}`;

  const firstDow   = new Date(curYear, curMonth, 1).getDay();
  const daysInMon  = new Date(curYear, curMonth + 1, 0).getDate();
  const daysInPrev = new Date(curYear, curMonth, 0).getDate();

  for (let i = 0; i < firstDow; i++)
    grid.appendChild(buildCell(curYear, curMonth - 1, daysInPrev - firstDow + 1 + i, true));
  for (let d = 1; d <= daysInMon; d++)
    grid.appendChild(buildCell(curYear, curMonth, d, false));
  const tail = (firstDow + daysInMon) % 7;
  if (tail) for (let d = 1; d <= 7 - tail; d++)
    grid.appendChild(buildCell(curYear, curMonth + 1, d, true));
}

function buildCell(year, month, day, other) {
  const norm = new Date(year, month, day);
  const y = norm.getFullYear(), m = norm.getMonth(), d = norm.getDate();
  const dk = fmtDate(y, m, d);
  const isToday = dk === todayKey;
  const cell = document.createElement('div');
  cell.className = 'day-cell' + (other ? ' other-month' : '') + (isToday ? ' today' : '');
  const num = document.createElement('div');
  num.className = 'day-num'; num.textContent = d;
  cell.appendChild(num);
  const dayEvs = eventsOn(dk);
  const MAX = 3;
  dayEvs.slice(0, MAX).forEach(ev => cell.appendChild(buildChip(ev)));
  if (dayEvs.length > MAX) {
    const more = document.createElement('div');
    more.className = 'more-events';
    more.textContent = `+${dayEvs.length - MAX} more`;
    cell.appendChild(more);
  }
  cell.addEventListener('click', e => {
    if (e.target.closest('.event-chip')) return;
    openDayModal(dk, y, m, d);
  });
  cell.querySelectorAll('.event-chip').forEach(c =>
    c.addEventListener('click', e => { e.stopPropagation(); openEdit(c.dataset.evid); })
  );
  return cell;
}

function buildChip(ev) {
  const office = OFFICES.find(o => o.id === ev.office);
  const color  = TYPE_COLOR[ev.type] || '#888';
  const chip = document.createElement('div');
  chip.className = 'event-chip';
  chip.dataset.evid = ev.id;
  chip.style.borderLeftColor = office ? office.color : '#555';
  chip.style.color = color;
  chip.innerHTML = `<div class="chip-dot" style="background:${color}"></div>`;
  const label = document.createElement('span');
  label.className = 'chip-text';
  label.textContent = ev.type === 'holiday' ? (ev.holidayName || 'Holiday') : (ev.name || TYPE_LABEL[ev.type]);
  chip.appendChild(label);
  if (ev.halfDay) {
    const hb = document.createElement('span');
    hb.className = 'chip-half'; hb.textContent = 'Â½';
    chip.appendChild(hb);
  }
  return chip;
}

// â”€â”€ Modals â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function closeAll() {
  document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('open'));
}

function setHalf(val) {
  halfActive = val;
  document.getElementById('half-day-toggle').classList.toggle('active', val);
}

function syncTypeUI() {
  const type = document.getElementById('entry-type').value;
  const isHol = type === 'holiday';
  document.getElementById('name-row').style.display    = isHol ? 'none' : '';
  document.getElementById('holiday-row').style.display = isHol ? '' : 'none';
  document.getElementById('name-label').textContent =
    type === 'team-member' ? 'Team Member Name' : type === 'employee-off' ? 'Employee Name' : 'Name';
}

function openAdd(prefillDate) {
  prefillDate = prefillDate || '';
  editingId = null;
  document.getElementById('modal-title').textContent  = 'Add Entry';
  document.getElementById('delete-btn').style.display = 'none';
  document.getElementById('entry-type').value         = 'team-member';
  document.getElementById('entry-office').value       = OFFICES[0].id;
  document.getElementById('entry-name').value         = '';
  document.getElementById('entry-holiday-name').value = '';
  document.getElementById('entry-date').value         = prefillDate;
  document.getElementById('entry-end-date').value     = '';
  document.getElementById('entry-note').value         = '';
  document.getElementById('save-btn').disabled        = false;
  setHalf(false); syncTypeUI();
  document.getElementById('event-modal').classList.add('open');
}

function openEdit(evId) {
  const ev = events.find(e => e.id === evId);
  if (!ev) return;
  editingId = ev.id;
  document.getElementById('modal-title').textContent  = 'Edit Entry';
  document.getElementById('delete-btn').style.display = '';
  document.getElementById('delete-btn').disabled      = false;
  document.getElementById('entry-type').value         = ev.type;
  document.getElementById('entry-office').value       = ev.office;
  document.getElementById('entry-name').value         = ev.name || '';
  document.getElementById('entry-holiday-name').value = ev.holidayName || '';
  document.getElementById('entry-date').value         = ev.date;
  document.getElementById('entry-end-date').value     = ev.endDate || '';
  document.getElementById('entry-note').value         = ev.note || '';
  document.getElementById('save-btn').disabled        = false;
  setHalf(!!ev.halfDay); syncTypeUI();
  document.getElementById('event-modal').classList.add('open');
}

function openDayModal(dk, y, m, d) {
  dayDate = dk;
  document.getElementById('day-modal-title').textContent = `${MONTHS[m]} ${d}, ${y}`;
  const list = document.getElementById('day-detail-list');
  list.innerHTML = '';
  const dayEvs = eventsOn(dk);
  if (!dayEvs.length) {
    list.innerHTML = '<div class="no-events">No entries for this day.</div>';
  } else {
    dayEvs.forEach(ev => {
      const office = OFFICES.find(o => o.id === ev.office);
      const card = document.createElement('div');
      card.className = 'detail-card';
      card.style.borderLeftColor = office ? office.color : '#555';
      const displayName = ev.type === 'holiday' ? (ev.holidayName || 'Holiday') : (ev.name || TYPE_LABEL[ev.type]);
      const halfHtml = ev.halfDay ? '<span class="detail-half">Â½ Day</span>' : '';
      const noteHtml = ev.note ? ` Â· ${ev.note}` : '';
      card.innerHTML = `
        <div class="detail-info">
          <div class="detail-name">${displayName}${halfHtml}</div>
          <div class="detail-meta">${office ? office.name : ''} Â· ${TYPE_LABEL[ev.type]}${noteHtml}</div>
        </div>
        <button class="detail-edit-btn" data-evid="${ev.id}">Edit</button>
      `;
      card.querySelector('.detail-edit-btn').addEventListener('click', () => {
        document.getElementById('day-modal').classList.remove('open');
        openEdit(ev.id);
      });
      list.appendChild(card);
    });
  }
  document.getElementById('day-modal').classList.add('open');
}

function populateOfficeSelect() {
  const sel = document.getElementById('entry-office');
  sel.innerHTML = '';
  OFFICES.forEach(o => {
    const opt = document.createElement('option');
    opt.value = o.id; opt.textContent = o.name;
    sel.appendChild(opt);
  });
}

// â”€â”€ Wire up â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('prev-btn').addEventListener('click', () => {
  curMonth--; if (curMonth < 0) { curMonth = 11; curYear--; } renderCalendar();
});
document.getElementById('next-btn').addEventListener('click', () => {
  curMonth++; if (curMonth > 11) { curMonth = 0; curYear++; } renderCalendar();
});
document.getElementById('today-btn').addEventListener('click', () => {
  curYear = today.getFullYear(); curMonth = today.getMonth(); renderCalendar();
});
document.getElementById('add-entry-btn').addEventListener('click', () => openAdd());
document.getElementById('entry-type').addEventListener('change', syncTypeUI);
document.getElementById('half-day-toggle').addEventListener('click', () => setHalf(!halfActive));
document.getElementById('cancel-btn').addEventListener('click', closeAll);
document.getElementById('day-close-btn').addEventListener('click', closeAll);
document.getElementById('day-add-btn').addEventListener('click', () => {
  document.getElementById('day-modal').classList.remove('open');
  openAdd(dayDate || '');
});

document.getElementById('save-btn').addEventListener('click', async () => {
  const type = document.getElementById('entry-type').value;
  const date = document.getElementById('entry-date').value;
  if (!date) { alert('Please select a date.'); return; }
  const ev = {
    type,
    office:      document.getElementById('entry-office').value,
    date,
    endDate:     document.getElementById('entry-end-date').value || '',
    name:        type !== 'holiday' ? document.getElementById('entry-name').value.trim() : '',
    holidayName: type === 'holiday' ? document.getElementById('entry-holiday-name').value.trim() : '',
    halfDay:     halfActive,
    note:        document.getElementById('entry-note').value.trim(),
  };
  document.getElementById('save-btn').disabled = true;
  showSaving('Savingâ€¦');
  closeAll();
  try {
    if (editingId) {
      await updateRow(editingId, ev);
      const idx = events.findIndex(e => e.id === editingId);
      if (idx >= 0) { ev.id = editingId; events[idx] = ev; }
    } else {
      const newId = await createRow(ev);
      ev.id = newId;
      events.push(ev);
    }
    showSaving('Saved âœ“', 'success');
    renderCalendar();
  } catch (err) {
    console.error(err);
    showSaving('Save failed â€” check connection', 'error');
    document.getElementById('save-btn').disabled = false;
  }
});

document.getElementById('delete-btn').addEventListener('click', async (e) => {
  e.stopPropagation();
  if (!editingId) return;
  document.getElementById('delete-btn').disabled = true;
  showSaving('Deletingâ€¦');
  closeAll();
  try {
    await deleteRow(editingId);
    // Remove from local events immediately
    events = events.filter(ev => String(ev.id) !== String(editingId));
    editingId = null;
    showSaving('Deleted âœ“', 'success');
    renderCalendar();
  } catch (err) {
    console.error('Delete error:', err);
    showSaving('Delete failed â€” check connection', 'error');
    document.getElementById('delete-btn').disabled = false;
  }
});

document.querySelectorAll('.modal-overlay').forEach(ov =>
  ov.addEventListener('click', e => { if (e.target === ov) closeAll(); })
);

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(async () => {
  try {
    document.getElementById('loading-msg').textContent = 'Connecting to Smartsheetâ€¦';
    await loadSheet();
    populateOfficeSelect();
    renderLegend();
    renderCalendar();
    hideLoading();
  } catch (err) {
    console.error(err);
    document.getElementById('loading-msg').textContent = 'Failed to connect. Please refresh and try again.';
  }
})();
</script>
</body>
</html>
