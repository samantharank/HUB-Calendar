<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>HUB Office Calendar</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0f0f13; --surface: #16161d; --surface2: #1e1e28;
    --border: #2a2a38; --text: #e8e8f0; --text-muted: #7a7a9a; --accent: #c8b8ff;
    --team-member: #f97316; --employee-off: #a78bfa; --holiday: #34d399; --half-day: #facc15;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { background: var(--bg); color: var(--text); font-family: 'DM Sans', sans-serif; min-height: 100vh; display: flex; flex-direction: column; }

  /* Loading */
  #loading-overlay { position: fixed; inset: 0; background: var(--bg); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 999; gap: 16px; }
  #loading-overlay h2 { font-family: 'DM Serif Display', serif; font-size: 1.6rem; }
  #loading-overlay h2 span { color: var(--accent); font-style: italic; }
  .spinner { width: 36px; height: 36px; border: 3px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; }
  @keyframes spin { to { transform: rotate(360deg); } }
  #loading-msg { font-size: 0.85rem; color: var(--text-muted); }

  /* Header */
  header { display: flex; align-items: center; justify-content: space-between; padding: 14px 24px; border-bottom: 1px solid var(--border); background: var(--surface); position: sticky; top: 0; z-index: 100; gap: 10px; flex-wrap: wrap; }
  header h1 { font-family: 'DM Serif Display', serif; font-size: 1.4rem; letter-spacing: -0.02em; white-space: nowrap; }
  header h1 span { color: var(--accent); font-style: italic; }

  .nav-controls { display: flex; align-items: center; gap: 8px; }
  .nav-btn { background: var(--surface2); border: 1px solid var(--border); color: var(--text); width: 32px; height: 32px; border-radius: 8px; cursor: pointer; font-size: 1.1rem; display: flex; align-items: center; justify-content: center; transition: background 0.15s, border-color 0.15s; }
  .nav-btn:hover { background: var(--border); border-color: var(--accent); }
  #month-label { font-family: 'DM Serif Display', serif; font-size: 1.05rem; min-width: 160px; text-align: center; }
  .today-btn { background: var(--surface2); border: 1px solid var(--border); color: var(--text-muted); padding: 5px 12px; border-radius: 8px; cursor: pointer; font-size: 0.78rem; font-family: 'DM Sans', sans-serif; transition: all 0.15s; }
  .today-btn:hover { border-color: var(--accent); color: var(--accent); }

  /* View switcher */
  .view-switcher { display: flex; background: var(--surface2); border: 1px solid var(--border); border-radius: 8px; overflow: hidden; }
  .view-btn { background: none; border: none; color: var(--text-muted); padding: 6px 14px; cursor: pointer; font-size: 0.78rem; font-family: 'DM Sans', sans-serif; font-weight: 500; transition: all 0.15s; white-space: nowrap; }
  .view-btn:hover { color: var(--text); }
  .view-btn.active { background: var(--accent); color: #0f0f13; font-weight: 600; }

  .add-btn { background: var(--accent); color: #0f0f13; border: none; padding: 7px 16px; border-radius: 8px; cursor: pointer; font-size: 0.85rem; font-weight: 600; font-family: 'DM Sans', sans-serif; transition: opacity 0.15s; white-space: nowrap; }
  .add-btn:hover { opacity: 0.85; }

  /* Layout */
  main { display: flex; flex: 1; overflow: hidden; }

  /* Left sidebar */
  .sidebar { width: 200px; min-width: 200px; background: var(--surface); border-right: 1px solid var(--border); padding: 16px 12px; overflow-y: auto; }
  .sidebar h3 { font-size: 0.65rem; font-weight: 600; letter-spacing: 0.12em; text-transform: uppercase; color: var(--text-muted); margin-bottom: 8px; margin-top: 4px; }
  .office-legend { display: flex; flex-direction: column; gap: 4px; margin-bottom: 20px; }
  .legend-item { display: flex; align-items: center; gap: 7px; padding: 4px 7px; border-radius: 6px; cursor: pointer; transition: background 0.12s; user-select: none; }
  .legend-item:hover { background: var(--surface2); }
  .legend-item.hidden { opacity: 0.3; }
  .legend-dot { width: 10px; height: 10px; border-radius: 3px; flex-shrink: 0; }
  .legend-item span { font-size: 0.77rem; }
  .type-legend { display: flex; flex-direction: column; gap: 6px; }
  .type-item { display: flex; align-items: flex-start; gap: 7px; padding: 2px 7px; }
  .type-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; margin-top: 4px; }
  .type-item-text { display: flex; flex-direction: column; }
  .type-item-label { font-size: 0.75rem; color: var(--text); }
  .type-item-sub { font-size: 0.64rem; color: var(--text-muted); margin-top: 1px; }

  /* Calendar area */
  .calendar-wrap { flex: 1; padding: 16px; overflow-y: auto; display: flex; flex-direction: column; }

  /* Day panel (right side) */
  .day-panel { width: 240px; min-width: 240px; background: var(--surface); border-left: 1px solid var(--border); padding: 16px 14px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
  .day-panel-title { font-family: 'DM Serif Display', serif; font-size: 1.05rem; color: var(--text); margin-bottom: 4px; }
  .day-panel-empty { color: var(--text-muted); font-size: 0.82rem; text-align: center; padding: 20px 0; }
  .day-panel-group { margin-bottom: 10px; }
  .day-panel-group-title { font-size: 0.62rem; font-weight: 600; letter-spacing: 0.1em; text-transform: uppercase; color: var(--text-muted); margin-bottom: 5px; padding-bottom: 4px; border-bottom: 1px solid var(--border); }
  .day-panel-entry { display: flex; align-items: center; gap: 7px; padding: 5px 0; border-bottom: 1px solid rgba(255,255,255,0.04); }
  .day-panel-entry:last-child { border-bottom: none; }
  .day-panel-dot { width: 7px; height: 7px; border-radius: 50%; flex-shrink: 0; }
  .day-panel-info { flex: 1; }
  .day-panel-name { font-size: 0.8rem; font-weight: 500; }
  .day-panel-type { font-size: 0.68rem; color: var(--text-muted); }
  .day-panel-half { font-size: 0.55rem; background: var(--half-day); color: #000; border-radius: 3px; padding: 1px 4px; font-weight: 700; }
  .day-panel-selected { background: var(--surface2); border-radius: 6px; padding: 4px 7px; margin-bottom: 8px; font-size: 0.72rem; color: var(--text-muted); }
  .day-panel-add { background: none; border: 1px dashed var(--border); color: var(--text-muted); width: 100%; padding: 7px; border-radius: 7px; cursor: pointer; font-size: 0.75rem; font-family: 'DM Sans', sans-serif; transition: all 0.15s; margin-top: 4px; }
  .day-panel-add:hover { border-color: var(--accent); color: var(--accent); }

  /* Month/Week grid */
  .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
  .day-header { text-align: center; font-size: 0.65rem; font-weight: 600; letter-spacing: 0.1em; text-transform: uppercase; color: var(--text-muted); padding: 5px 0 8px; }
  .day-cell { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; min-height: 100px; padding: 6px; position: relative; cursor: pointer; transition: border-color 0.12s; }
  .day-cell:hover { border-color: var(--accent); }
  .day-cell.other-month { opacity: 0.25; }
  .day-cell.today { border-color: var(--accent); }
  .day-cell.today .day-num { color: var(--accent); font-weight: 700; }
  .day-cell.selected { border-color: var(--accent); background: rgba(200,184,255,0.06); }
  .day-num { font-size: 0.78rem; font-weight: 600; color: var(--text-muted); margin-bottom: 3px; }

  /* Week view - taller cells */
  .week-view .day-cell { min-height: 160px; }

  /* Event chips */
  .event-chip { display: flex; align-items: center; gap: 3px; padding: 2px 5px; border-radius: 4px; font-size: 0.65rem; font-weight: 500; margin-bottom: 2px; cursor: pointer; background: rgba(255,255,255,0.055); border-left: 3px solid transparent; max-width: 100%; overflow: hidden; }
  .event-chip:hover { filter: brightness(1.25); }
  .chip-dot { width: 5px; height: 5px; border-radius: 50%; flex-shrink: 0; }
  .chip-text { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; flex: 1; }
  .chip-half { font-size: 0.52rem; background: var(--half-day); color: #000; border-radius: 3px; padding: 0 3px; font-weight: 700; flex-shrink: 0; }
  .more-events { font-size: 0.62rem; color: var(--text-muted); padding: 1px 4px; cursor: pointer; }
  .more-events:hover { color: var(--accent); }

  /* List view */
  .list-view { display: flex; flex-direction: column; gap: 20px; }
  .list-office-group { background: var(--surface); border: 1px solid var(--border); border-radius: 10px; overflow: hidden; }
  .list-office-header { display: flex; align-items: center; gap: 10px; padding: 12px 16px; border-bottom: 1px solid var(--border); }
  .list-office-dot { width: 12px; height: 12px; border-radius: 3px; flex-shrink: 0; }
  .list-office-name { font-weight: 600; font-size: 0.9rem; }
  .list-office-count { font-size: 0.72rem; color: var(--text-muted); margin-left: auto; }
  .list-entry { display: flex; align-items: center; gap: 12px; padding: 10px 16px; border-bottom: 1px solid rgba(255,255,255,0.04); cursor: pointer; transition: background 0.12s; }
  .list-entry:last-child { border-bottom: none; }
  .list-entry:hover { background: var(--surface2); }
  .list-entry-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
  .list-entry-info { flex: 1; }
  .list-entry-name { font-size: 0.85rem; font-weight: 500; display: flex; align-items: center; gap: 6px; }
  .list-entry-meta { font-size: 0.72rem; color: var(--text-muted); margin-top: 2px; }
  .list-half { font-size: 0.55rem; background: var(--half-day); color: #000; border-radius: 3px; padding: 1px 4px; font-weight: 700; }
  .list-empty { color: var(--text-muted); font-size: 0.85rem; text-align: center; padding: 40px 0; }

  /* Saving indicator */
  .saving-indicator { position: fixed; bottom: 20px; right: 20px; background: var(--surface2); border: 1px solid var(--border); border-radius: 8px; padding: 8px 14px; font-size: 0.78rem; color: var(--text-muted); display: none; align-items: center; gap: 8px; z-index: 150; }
  .saving-indicator.show { display: flex; }
  .saving-indicator.success { border-color: var(--holiday); color: var(--holiday); }
  .saving-indicator.error { border-color: #ff6b6b; color: #ff6b6b; }

  /* Modals */
  .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.72); z-index: 200; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
  .modal-overlay.open { display: flex; }
  .modal { background: var(--surface); border: 1px solid var(--border); border-radius: 16px; padding: 26px; width: 440px; max-width: 96vw; max-height: 90vh; overflow-y: auto; animation: slideUp 0.18s ease; }
  @keyframes slideUp { from { transform: translateY(14px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
  .modal h2 { font-family: 'DM Serif Display', serif; font-size: 1.25rem; margin-bottom: 18px; }
  .form-row { margin-bottom: 13px; }
  .form-row label { display: block; font-size: 0.72rem; font-weight: 600; letter-spacing: 0.08em; text-transform: uppercase; color: var(--text-muted); margin-bottom: 5px; }
  .form-row label .sub { font-weight: 400; text-transform: none; letter-spacing: 0; }
  .form-row select, .form-row input[type="date"], .form-row input[type="text"] { width: 100%; background: var(--surface2); border: 1px solid var(--border); color: var(--text); padding: 9px 11px; border-radius: 8px; font-family: 'DM Sans', sans-serif; font-size: 0.84rem; appearance: none; transition: border-color 0.15s; }
  .form-row select:focus, .form-row input:focus { outline: none; border-color: var(--accent); }
  .half-day-toggle { display: flex; align-items: center; gap: 10px; padding: 9px 11px; background: var(--surface2); border: 1px solid var(--border); border-radius: 8px; cursor: pointer; transition: border-color 0.15s; user-select: none; }
  .half-day-toggle:hover { border-color: var(--half-day); }
  .half-day-toggle.active { border-color: var(--half-day); background: rgba(250,204,21,0.08); }
  .toggle-switch { width: 32px; height: 18px; background: var(--border); border-radius: 9px; position: relative; transition: background 0.2s; flex-shrink: 0; }
  .toggle-switch::after { content: ''; position: absolute; top: 2px; left: 2px; width: 14px; height: 14px; border-radius: 50%; background: var(--text-muted); transition: transform 0.2s, background 0.2s; }
  .half-day-toggle.active .toggle-switch { background: var(--half-day); }
  .half-day-toggle.active .toggle-switch::after { transform: translateX(14px); background: #000; }
  .toggle-label { font-size: 0.83rem; color: var(--text); }
  .modal-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 18px; }
  .btn-cancel { background: var(--surface2); border: 1px solid var(--border); color: var(--text-muted); padding: 8px 17px; border-radius: 8px; cursor: pointer; font-family: 'DM Sans', sans-serif; font-size: 0.84rem; transition: all 0.15s; }
  .btn-cancel:hover { border-color: var(--text-muted); color: var(--text); }
  .btn-save { background: var(--accent); color: #0f0f13; border: none; padding: 8px 20px; border-radius: 8px; cursor: pointer; font-family: 'DM Sans', sans-serif; font-size: 0.84rem; font-weight: 600; transition: opacity 0.15s; }
  .btn-save:hover { opacity: 0.85; }
  .btn-save:disabled { opacity: 0.5; cursor: not-allowed; }
  .btn-delete { background: transparent; border: 1px solid #ff6b6b; color: #ff6b6b; padding: 8px 14px; border-radius: 8px; cursor: pointer; font-family: 'DM Sans', sans-serif; font-size: 0.84rem; transition: all 0.15s; margin-right: auto; }
  .btn-delete:hover { background: rgba(255,107,107,0.1); }
  .btn-delete:disabled { opacity: 0.5; cursor: not-allowed; }

  @media (max-width: 900px) {
    .sidebar { display: none; }
    .day-panel { display: none; }
    header { padding: 10px 12px; }
    .calendar-wrap { padding: 8px; }
    .day-cell { min-height: 70px; }
  }
</style>
</head>
<body>

<div id="loading-overlay">
  <h2>HUB <span>Office Calendar</span></h2>
  <div class="spinner"></div>
  <div id="loading-msg">Loading calendarâ€¦</div>
</div>

<header>
  <h1>HUB <span>Office Calendar</span></h1>
  <div class="nav-controls">
    <button class="nav-btn" id="prev-btn">&#8249;</button>
    <span id="month-label"></span>
    <button class="nav-btn" id="next-btn">&#8250;</button>
    <button class="today-btn" id="today-btn">Today</button>
  </div>
  <div class="view-switcher">
    <button class="view-btn active" data-view="month">Month</button>
    <button class="view-btn" data-view="week">Week</button>
    <button class="view-btn" data-view="list">List</button>
  </div>
  <button class="add-btn" id="add-entry-btn">+ Add Entry</button>
</header>

<main>
  <aside class="sidebar">
    <h3>Offices</h3>
    <div class="office-legend" id="office-legend"></div>
    <h3>Entry Types</h3>
    <div class="type-legend">
      <div class="type-item">
        <div class="type-dot" style="background:var(--team-member)"></div>
        <div class="type-item-text">
          <span class="type-item-label">Team Member Off</span>
          <span class="type-item-sub">OS Team Member</span>
        </div>
      </div>
      <div class="type-item">
        <div class="type-dot" style="background:var(--employee-off)"></div>
        <div class="type-item-text">
          <span class="type-item-label">Employee Off</span>
          <span class="type-item-sub">Personal / Commercial Lines</span>
        </div>
      </div>
      <div class="type-item">
        <div class="type-dot" style="background:var(--holiday)"></div>
        <div class="type-item-text"><span class="type-item-label">Holiday / Stat Day</span></div>
      </div>
      <div class="type-item">
        <div class="type-dot" style="background:var(--half-day)"></div>
        <div class="type-item-text">
          <span class="type-item-label">Â½ Half Day</span>
          <span class="type-item-sub">Add-on flag for any entry</span>
        </div>
      </div>
    </div>
  </aside>

  <div class="calendar-wrap" id="calendar-wrap">
    <!-- Rendered by JS -->
  </div>

  <!-- Day panel -->
  <div class="day-panel" id="day-panel">
    <div class="day-panel-title">Who's Off</div>
    <div class="day-panel-selected" id="day-panel-date">Click a day to see entries</div>
    <div id="day-panel-content">
      <div class="day-panel-empty">Select a day on the calendar</div>
    </div>
    <button class="day-panel-add" id="day-panel-add-btn" style="display:none">+ Add Entry for this Day</button>
  </div>
</main>

<!-- Add / Edit Modal -->
<div class="modal-overlay" id="event-modal">
  <div class="modal">
    <h2 id="modal-title">Add Entry</h2>
    <div class="form-row">
      <label>Entry Type</label>
      <select id="entry-type">
        <option value="team-member">Team Member Off (OS Team Member)</option>
        <option value="employee-off">Employee Off (Personal / Commercial Lines)</option>
        <option value="holiday">Holiday / Stat Day</option>
      </select>
    </div>
    <div class="form-row">
      <label>Office</label>
      <select id="entry-office"></select>
    </div>
    <div class="form-row" id="name-row">
      <label id="name-label">Name</label>
      <input type="text" id="entry-name" placeholder="Type nameâ€¦">
    </div>
    <div class="form-row" id="holiday-row" style="display:none">
      <label>Holiday Name</label>
      <input type="text" id="entry-holiday-name" placeholder="e.g. Victoria Day">
    </div>
    <div class="form-row">
      <label>Date</label>
      <input type="date" id="entry-date">
    </div>
    <div class="form-row">
      <label>End Date <span class="sub">(optional â€” for multi-day)</span></label>
      <input type="date" id="entry-end-date">
    </div>
    <div class="form-row">
      <label>Half Day</label>
      <div class="half-day-toggle" id="half-day-toggle">
        <div class="toggle-switch"></div>
        <span class="toggle-label">Mark as half day</span>
      </div>
    </div>
    <div class="form-row">
      <label>Note <span class="sub">(optional)</span></label>
      <input type="text" id="entry-note" placeholder="Any detailsâ€¦">
    </div>
    <div class="modal-actions">
      <button class="btn-delete" id="delete-btn" style="display:none">ðŸ—‘ Delete Entry</button>
      <button class="btn-cancel" id="cancel-btn">Cancel</button>
      <button class="btn-save" id="save-btn">Save Entry</button>
    </div>
  </div>
</div>

<div class="saving-indicator" id="saving-indicator">
  <div class="spinner" style="width:14px;height:14px;border-width:2px"></div>
  <span id="saving-msg">Savingâ€¦</span>
</div>

<script>
// â”€â”€ Proxy â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const PROXY = '/.netlify/functions/smartsheet';

const OFFICES = [
  { id:'markham',      name:'Markham',        color:'#ff7c7c' },
  { id:'brantford',    name:'Brantford',       color:'#ffaa55' },
  { id:'london',       name:'London',          color:'#ffd155' },
  { id:'sarnia',       name:'Sarnia',          color:'#7ddf8e' },
  { id:'chatham',      name:'Chatham',         color:'#5dc8c8' },
  { id:'barrie',       name:'Barrie',          color:'#6fa8ff' },
  { id:'oakville',     name:'Oakville',        color:'#b07dff' },
  { id:'toronto',      name:'Toronto',         color:'#ff82c8' },
  { id:'stcatharines', name:"St. Catharines",  color:'#e06bff' },
];

const TYPE_COLOR = { 'team-member':'#f97316', 'employee-off':'#a78bfa', 'holiday':'#34d399' };
const TYPE_LABEL = { 'team-member':'Team Member Off', 'employee-off':'Employee Off', 'holiday':'Holiday / Stat Day' };
const MONTHS = ['January','February','March','April','May','June','July','August','September','October','November','December'];
const DAYS_SHORT = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
const REQUIRED_COLS = ['EntryType','OfficeName','EntryDate','EndDate','EntryName','HolidayName','HalfDay','Note'];

const today  = new Date();
let curYear  = today.getFullYear();
let curMonth = today.getMonth();
let curWeekStart = getWeekStart(today);
const todayKey = fmtDate(today.getFullYear(), today.getMonth(), today.getDate());

let events        = [];
let hiddenOffices = new Set(JSON.parse(localStorage.getItem('hub_hidden_ss') || '[]'));
let halfActive    = false;
let editingId     = null;
let selectedDay   = null;
let currentView   = 'month';
let COL           = {};

// â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function fmtDate(y, m, d) {
  return `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
}

function getWeekStart(date) {
  const d = new Date(date);
  d.setDate(d.getDate() - d.getDay());
  return d;
}

function eventsOn(dk) {
  return events.filter(e => {
    if (!e.type) return false;
    if (e.type !== 'holiday' && hiddenOffices.has(e.office)) return false;
    if (!e.endDate || e.endDate === e.date) return e.date === dk;
    return dk >= e.date && dk <= e.endDate;
  });
}

function showSaving(msg, type) {
  const el = document.getElementById('saving-indicator');
  el.className = 'saving-indicator show' + (type ? ' ' + type : '');
  document.getElementById('saving-msg').textContent = msg;
  if (type === 'success' || type === 'error') setTimeout(() => el.classList.remove('show'), 3000);
}

function hideLoading() {
  document.getElementById('loading-overlay').style.display = 'none';
}

// â”€â”€ API â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function api(action, method, body, extra) {
  let url = `${PROXY}?action=${action}`;
  if (extra) url += `&${extra}`;
  const opts = { method: method || 'GET', headers: { 'Content-Type': 'application/json' } };
  if (body) opts.body = JSON.stringify(body);
  const res  = await fetch(url, opts);
  const text = await res.text();
  try { return JSON.parse(text); } catch { return text; }
}

// â”€â”€ Sheet setup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadSheet() {
  const data = await api('sheet', 'GET');
  if (!data || data.errorCode) throw new Error(data ? data.message : 'No response');

  const cols = data.columns || [];
  const primary = cols.find(c => c.primary);
  if (primary && primary.title !== 'EntryType') {
    await api('updatecol', 'PUT', { title: 'EntryType', type: 'TEXT_NUMBER', primary: true }, `colId=${primary.id}`);
  }

  const nonPrimary = cols.filter(c => !c.primary);
  const needed = ['OfficeName','EntryDate','EndDate','EntryName','HolidayName','HalfDay','Note'];
  const colType = n => (n==='EntryDate'||n==='EndDate') ? 'DATE' : n==='HalfDay' ? 'CHECKBOX' : 'TEXT_NUMBER';

  for (let i = 0; i < needed.length; i++) {
    const name = needed[i];
    if (cols.find(c => c.title === name)) continue;
    const defaultCol = nonPrimary[i];
    if (defaultCol && defaultCol.title.startsWith('Column')) {
      await api('updatecol', 'PUT', { title: name, type: colType(name) }, `colId=${defaultCol.id}`);
    } else {
      await api('addcol', 'POST', [{ title: name, type: colType(name) }]);
    }
  }

  const fresh = await api('sheet', 'GET');
  if (!fresh || fresh.errorCode) throw new Error('Failed to reload sheet');
  fresh.columns.forEach(c => { COL[c.title] = c.id; });

  events = (fresh.rows || [])
    .map(row => {
      const get = name => {
        const cell = (row.cells || []).find(c => c.columnId === COL[name]);
        return cell ? (cell.value ?? '') : '';
      };
      return {
        id:          String(row.id),
        type:        get('EntryType')   || '',
        office:      get('OfficeName')  || '',
        date:        get('EntryDate')   ? String(get('EntryDate')).split('T')[0] : '',
        endDate:     get('EndDate')     ? String(get('EndDate')).split('T')[0]   : '',
        name:        get('EntryName')   || '',
        holidayName: get('HolidayName') || '',
        halfDay:     get('HalfDay') === true || get('HalfDay') === 'true',
        note:        get('Note')        || '',
      };
    })
    .filter(e => e.type && e.date);
}

function buildCells(ev) {
  return [
    { columnId: COL['EntryType'],   value: ev.type        || '' },
    { columnId: COL['OfficeName'],  value: ev.office      || '' },
    { columnId: COL['EntryDate'],   value: ev.date        || '' },
    { columnId: COL['EndDate'],     value: ev.endDate     || '' },
    { columnId: COL['EntryName'],   value: ev.name        || '' },
    { columnId: COL['HolidayName'], value: ev.holidayName || '' },
    { columnId: COL['HalfDay'],     value: ev.halfDay     || false },
    { columnId: COL['Note'],        value: ev.note        || '' },
  ];
}

async function createRow(ev) {
  const res = await api('addrow', 'POST', [{ toBottom: true, cells: buildCells(ev) }]);
  if (res && res.errorCode) throw new Error(res.message);
  return String(res.result[0].id);
}

async function updateRow(rowId, ev) {
  const res = await api('updaterow', 'PUT', [{ id: Number(rowId), cells: buildCells(ev) }]);
  if (res && res.errorCode) throw new Error(res.message);
}

async function deleteRow(rowId) {
  const res = await api('deleterow', 'DELETE', null, `rowId=${rowId}`);
  if (res && res.errorCode) throw new Error(res.message || 'Delete failed');
}

// â”€â”€ Legend â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderLegend() {
  const el = document.getElementById('office-legend');
  el.innerHTML = '';
  OFFICES.forEach(o => {
    const item = document.createElement('div');
    item.className = 'legend-item' + (hiddenOffices.has(o.id) ? ' hidden' : '');
    item.innerHTML = `<div class="legend-dot" style="background:${o.color}"></div><span>${o.name}</span>`;
    item.addEventListener('click', () => {
      hiddenOffices.has(o.id) ? hiddenOffices.delete(o.id) : hiddenOffices.add(o.id);
      localStorage.setItem('hub_hidden_ss', JSON.stringify([...hiddenOffices]));
      renderLegend(); renderView();
    });
    el.appendChild(item);
  });
}

// â”€â”€ View router â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderView() {
  const wrap = document.getElementById('calendar-wrap');
  if (!wrap) return;
  if (currentView === 'month') renderMonth();
  else if (currentView === 'week') renderWeek();
  else renderList();
  updateLabel();
}

function updateLabel() {
  const label = document.getElementById('month-label');
  if (currentView === 'month') {
    label.textContent = `${MONTHS[curMonth]} ${curYear}`;
  } else if (currentView === 'week') {
    const end = new Date(curWeekStart);
    end.setDate(end.getDate() + 6);
    label.textContent = `${MONTHS[curWeekStart.getMonth()]} ${curWeekStart.getDate()} â€“ ${curWeekStart.getDate() !== end.getDate() ? (curWeekStart.getMonth() !== end.getMonth() ? MONTHS[end.getMonth()] + ' ' : '') + end.getDate() : ''} ${end.getFullYear()}`;
  } else {
    label.textContent = `${MONTHS[curMonth]} ${curYear} â€” List`;
  }
}

// â”€â”€ Month view â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderMonth() {
  const wrap = document.getElementById('calendar-wrap');
  wrap.innerHTML = '';

  const grid = document.createElement('div');
  grid.className = 'calendar-grid';

  DAYS_SHORT.forEach(d => {
    const h = document.createElement('div');
    h.className = 'day-header'; h.textContent = d;
    grid.appendChild(h);
  });

  const firstDow   = new Date(curYear, curMonth, 1).getDay();
  const daysInMon  = new Date(curYear, curMonth + 1, 0).getDate();
  const daysInPrev = new Date(curYear, curMonth, 0).getDate();

  for (let i = 0; i < firstDow; i++)
    grid.appendChild(buildCell(curYear, curMonth - 1, daysInPrev - firstDow + 1 + i, true));
  for (let d = 1; d <= daysInMon; d++)
    grid.appendChild(buildCell(curYear, curMonth, d, false));
  const tail = (firstDow + daysInMon) % 7;
  if (tail) for (let d = 1; d <= 7 - tail; d++)
    grid.appendChild(buildCell(curYear, curMonth + 1, d, true));

  wrap.appendChild(grid);
}

// â”€â”€ Week view â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderWeek() {
  const wrap = document.getElementById('calendar-wrap');
  wrap.innerHTML = '';

  const grid = document.createElement('div');
  grid.className = 'calendar-grid week-view';

  DAYS_SHORT.forEach(d => {
    const h = document.createElement('div');
    h.className = 'day-header'; h.textContent = d;
    grid.appendChild(h);
  });

  for (let i = 0; i < 7; i++) {
    const d = new Date(curWeekStart);
    d.setDate(d.getDate() + i);
    grid.appendChild(buildCell(d.getFullYear(), d.getMonth(), d.getDate(), false, true));
  }

  wrap.appendChild(grid);
}

// â”€â”€ List view â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderList() {
  const wrap = document.getElementById('calendar-wrap');
  wrap.innerHTML = '';

  // Get all events for the current month sorted by date
  const monthStart = fmtDate(curYear, curMonth, 1);
  const monthEnd   = fmtDate(curYear, curMonth, new Date(curYear, curMonth + 1, 0).getDate());

  const monthEvents = events
    .filter(e => e.date >= monthStart && e.date <= monthEnd)
    .sort((a, b) => a.date.localeCompare(b.date));

  if (!monthEvents.length) {
    const empty = document.createElement('div');
    empty.className = 'list-empty';
    empty.textContent = 'No entries for this month.';
    wrap.appendChild(empty);
    return;
  }

  // Group by office
  const grouped = {};
  OFFICES.forEach(o => { grouped[o.id] = []; });
  monthEvents.forEach(e => {
    if (grouped[e.office]) grouped[e.office].push(e);
    else grouped['other'] = [...(grouped['other'] || []), e];
  });

  const listWrap = document.createElement('div');
  listWrap.className = 'list-view';

  OFFICES.forEach(o => {
    const officeEvents = grouped[o.id] || [];
    if (!officeEvents.length) return;
    if (hiddenOffices.has(o.id)) return;

    const group = document.createElement('div');
    group.className = 'list-office-group';

    const header = document.createElement('div');
    header.className = 'list-office-header';
    header.innerHTML = `
      <div class="list-office-dot" style="background:${o.color}"></div>
      <span class="list-office-name">${o.name}</span>
      <span class="list-office-count">${officeEvents.length} entr${officeEvents.length === 1 ? 'y' : 'ies'}</span>
    `;
    group.appendChild(header);

    officeEvents.forEach(ev => {
      const color = TYPE_COLOR[ev.type] || '#888';
      const entry = document.createElement('div');
      entry.className = 'list-entry';
      const displayName = ev.type === 'holiday' ? (ev.holidayName || 'Holiday') : (ev.name || TYPE_LABEL[ev.type]);
      const dateStr = ev.endDate && ev.endDate !== ev.date ? `${ev.date} â†’ ${ev.endDate}` : ev.date;
      const halfHtml = ev.halfDay ? '<span class="list-half">Â½</span>' : '';
      const noteStr = ev.note ? ` Â· ${ev.note}` : '';
      entry.innerHTML = `
        <div class="list-entry-dot" style="background:${color}"></div>
        <div class="list-entry-info">
          <div class="list-entry-name">${displayName}${halfHtml}</div>
          <div class="list-entry-meta">${TYPE_LABEL[ev.type]} Â· ${dateStr}${noteStr}</div>
        </div>
      `;
      entry.addEventListener('click', () => openEdit(ev.id));
      group.appendChild(entry);
    });

    listWrap.appendChild(group);
  });

  wrap.appendChild(listWrap);
}

// â”€â”€ Cell builder â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildCell(year, month, day, other, forceShow) {
  const norm = new Date(year, month, day);
  const y = norm.getFullYear(), m = norm.getMonth(), d = norm.getDate();
  const dk = fmtDate(y, m, d);
  const isToday = dk === todayKey;
  const isSelected = dk === selectedDay;

  const cell = document.createElement('div');
  cell.className = 'day-cell'
    + (other && !forceShow ? ' other-month' : '')
    + (isToday ? ' today' : '')
    + (isSelected ? ' selected' : '');
  cell.dataset.date = dk;

  const num = document.createElement('div');
  num.className = 'day-num';
  num.textContent = d;
  cell.appendChild(num);

  const dayEvs = eventsOn(dk);
  const MAX = currentView === 'week' ? 6 : 3;
  dayEvs.slice(0, MAX).forEach(ev => cell.appendChild(buildChip(ev)));
  if (dayEvs.length > MAX) {
    const more = document.createElement('div');
    more.className = 'more-events';
    more.textContent = `+${dayEvs.length - MAX} more`;
    cell.appendChild(more);
  }

  cell.addEventListener('click', e => {
    if (e.target.closest('.event-chip')) return;
    selectDay(dk, y, m, d);
  });
  cell.querySelectorAll('.event-chip').forEach(c =>
    c.addEventListener('click', e => { e.stopPropagation(); openEdit(c.dataset.evid); })
  );
  return cell;
}

function buildChip(ev) {
  const office = OFFICES.find(o => o.id === ev.office);
  const color  = TYPE_COLOR[ev.type] || '#888';
  const chip = document.createElement('div');
  chip.className = 'event-chip';
  chip.dataset.evid = ev.id;
  chip.style.borderLeftColor = office ? office.color : '#555';
  chip.style.color = color;
  chip.innerHTML = `<div class="chip-dot" style="background:${color}"></div>`;
  const label = document.createElement('span');
  label.className = 'chip-text';
  label.textContent = ev.type === 'holiday' ? (ev.holidayName || 'Holiday') : (ev.name || TYPE_LABEL[ev.type]);
  chip.appendChild(label);
  if (ev.halfDay) {
    const hb = document.createElement('span');
    hb.className = 'chip-half'; hb.textContent = 'Â½';
    chip.appendChild(hb);
  }
  return chip;
}

// â”€â”€ Day panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function selectDay(dk, y, m, d) {
  selectedDay = dk;
  renderView(); // re-render to show selected highlight

  const MONTH_NAMES = MONTHS;
  document.getElementById('day-panel-date').textContent = `${MONTH_NAMES[m]} ${d}, ${y}`;

  const content = document.getElementById('day-panel-content');
  content.innerHTML = '';

  const dayEvs = eventsOn(dk);

  if (!dayEvs.length) {
    content.innerHTML = '<div class="day-panel-empty">No entries for this day.</div>';
  } else {
    // Group by office
    const grouped = {};
    dayEvs.forEach(ev => {
      if (!grouped[ev.office]) grouped[ev.office] = [];
      grouped[ev.office].push(ev);
    });

    OFFICES.forEach(o => {
      const offEvs = grouped[o.id] || [];
      if (!offEvs.length) return;

      const group = document.createElement('div');
      group.className = 'day-panel-group';

      const title = document.createElement('div');
      title.className = 'day-panel-group-title';
      title.style.color = o.color;
      title.textContent = o.name;
      group.appendChild(title);

      offEvs.forEach(ev => {
        const color = TYPE_COLOR[ev.type] || '#888';
        const displayName = ev.type === 'holiday' ? (ev.holidayName || 'Holiday') : (ev.name || TYPE_LABEL[ev.type]);
        const row = document.createElement('div');
        row.className = 'day-panel-entry';
        row.innerHTML = `
          <div class="day-panel-dot" style="background:${color}"></div>
          <div class="day-panel-info">
            <div class="day-panel-name">${displayName}${ev.halfDay ? ' <span class="day-panel-half">Â½</span>' : ''}</div>
            <div class="day-panel-type">${TYPE_LABEL[ev.type]}</div>
          </div>
        `;
        row.style.cursor = 'pointer';
        row.addEventListener('click', () => openEdit(ev.id));
        group.appendChild(row);
      });

      content.appendChild(group);
    });

    // Handle holidays and unmatched offices
    const holidayEvs = dayEvs.filter(ev => ev.type === 'holiday' && !OFFICES.find(o => o.id === ev.office));
    if (holidayEvs.length) {
      const group = document.createElement('div');
      group.className = 'day-panel-group';
      const title = document.createElement('div');
      title.className = 'day-panel-group-title';
      title.textContent = 'Holidays';
      group.appendChild(title);
      holidayEvs.forEach(ev => {
        const row = document.createElement('div');
        row.className = 'day-panel-entry';
        row.innerHTML = `
          <div class="day-panel-dot" style="background:${TYPE_COLOR.holiday}"></div>
          <div class="day-panel-info">
            <div class="day-panel-name">${ev.holidayName || 'Holiday'}</div>
            <div class="day-panel-type">Holiday / Stat Day</div>
          </div>
        `;
        group.appendChild(row);
      });
      content.appendChild(group);
    }
  }

  // Show add button for selected day
  const addBtn = document.getElementById('day-panel-add-btn');
  addBtn.style.display = '';
  addBtn.onclick = () => openAdd(dk);
}

// â”€â”€ Modals â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function closeAll() {
  document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('open'));
}

function setHalf(val) {
  halfActive = val;
  document.getElementById('half-day-toggle').classList.toggle('active', val);
}

function syncTypeUI() {
  const type = document.getElementById('entry-type').value;
  const isHol = type === 'holiday';
  document.getElementById('name-row').style.display    = isHol ? 'none' : '';
  document.getElementById('holiday-row').style.display = isHol ? '' : 'none';
  document.getElementById('name-label').textContent =
    type === 'team-member' ? 'Team Member Name' : type === 'employee-off' ? 'Employee Name' : 'Name';
}

function openAdd(prefillDate) {
  prefillDate = prefillDate || '';
  editingId = null;
  document.getElementById('modal-title').textContent  = 'Add Entry';
  document.getElementById('delete-btn').style.display = 'none';
  document.getElementById('entry-type').value         = 'team-member';
  document.getElementById('entry-office').value       = OFFICES[0].id;
  document.getElementById('entry-name').value         = '';
  document.getElementById('entry-holiday-name').value = '';
  document.getElementById('entry-date').value         = prefillDate;
  document.getElementById('entry-end-date').value     = '';
  document.getElementById('entry-note').value         = '';
  document.getElementById('save-btn').disabled        = false;
  setHalf(false); syncTypeUI();
  document.getElementById('event-modal').classList.add('open');
}

function openEdit(evId) {
  const ev = events.find(e => e.id === evId);
  if (!ev) return;
  editingId = ev.id;
  document.getElementById('modal-title').textContent  = 'Edit Entry';
  document.getElementById('delete-btn').style.display = '';
  document.getElementById('delete-btn').disabled      = false;
  document.getElementById('entry-type').value         = ev.type;
  document.getElementById('entry-office').value       = ev.office;
  document.getElementById('entry-name').value         = ev.name || '';
  document.getElementById('entry-holiday-name').value = ev.holidayName || '';
  document.getElementById('entry-date').value         = ev.date;
  document.getElementById('entry-end-date').value     = ev.endDate || '';
  document.getElementById('entry-note').value         = ev.note || '';
  document.getElementById('save-btn').disabled        = false;
  setHalf(!!ev.halfDay); syncTypeUI();
  document.getElementById('event-modal').classList.add('open');
}

function populateOfficeSelect() {
  const sel = document.getElementById('entry-office');
  sel.innerHTML = '';
  OFFICES.forEach(o => {
    const opt = document.createElement('option');
    opt.value = o.id; opt.textContent = o.name;
    sel.appendChild(opt);
  });
}

// â”€â”€ Refresh day panel after changes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function refreshDayPanel() {
  if (!selectedDay) return;
  const [y, m, d] = selectedDay.split('-').map(Number);
  selectDay(selectedDay, y, m - 1, d);
}

// â”€â”€ Nav â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('prev-btn').addEventListener('click', () => {
  if (currentView === 'week') {
    curWeekStart.setDate(curWeekStart.getDate() - 7);
  } else {
    curMonth--; if (curMonth < 0) { curMonth = 11; curYear--; }
  }
  renderView();
});
document.getElementById('next-btn').addEventListener('click', () => {
  if (currentView === 'week') {
    curWeekStart.setDate(curWeekStart.getDate() + 7);
  } else {
    curMonth++; if (curMonth > 11) { curMonth = 0; curYear++; }
  }
  renderView();
});
document.getElementById('today-btn').addEventListener('click', () => {
  curYear = today.getFullYear(); curMonth = today.getMonth();
  curWeekStart = getWeekStart(today);
  renderView();
});

// View switcher
document.querySelectorAll('.view-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    currentView = btn.dataset.view;
    renderView();
  });
});

document.getElementById('add-entry-btn').addEventListener('click', () => openAdd());
document.getElementById('entry-type').addEventListener('change', syncTypeUI);
document.getElementById('half-day-toggle').addEventListener('click', () => setHalf(!halfActive));
document.getElementById('cancel-btn').addEventListener('click', closeAll);

document.getElementById('save-btn').addEventListener('click', async () => {
  const type = document.getElementById('entry-type').value;
  const date = document.getElementById('entry-date').value;
  if (!date) { alert('Please select a date.'); return; }
  const ev = {
    type,
    office:      document.getElementById('entry-office').value,
    date,
    endDate:     document.getElementById('entry-end-date').value || '',
    name:        type !== 'holiday' ? document.getElementById('entry-name').value.trim() : '',
    holidayName: type === 'holiday' ? document.getElementById('entry-holiday-name').value.trim() : '',
    halfDay:     halfActive,
    note:        document.getElementById('entry-note').value.trim(),
  };
  document.getElementById('save-btn').disabled = true;
  showSaving('Savingâ€¦');
  closeAll();
  try {
    if (editingId) {
      await updateRow(editingId, ev);
      const idx = events.findIndex(e => e.id === editingId);
      if (idx >= 0) { ev.id = editingId; events[idx] = ev; }
    } else {
      const newId = await createRow(ev);
      ev.id = newId; events.push(ev);
    }
    showSaving('Saved âœ“', 'success');
    renderView();
    if (selectedDay) refreshDayPanel();
  } catch (err) {
    console.error(err);
    showSaving('Save failed â€” check connection', 'error');
    document.getElementById('save-btn').disabled = false;
  }
});

document.getElementById('delete-btn').addEventListener('click', async (e) => {
  e.stopPropagation();
  if (!editingId) return;
  document.getElementById('delete-btn').disabled = true;
  showSaving('Deletingâ€¦');
  closeAll();
  try {
    await deleteRow(editingId);
    events = events.filter(ev => String(ev.id) !== String(editingId));
    editingId = null;
    showSaving('Deleted âœ“', 'success');
    renderView();
    if (selectedDay) refreshDayPanel();
  } catch (err) {
    console.error('Delete error:', err);
    showSaving('Delete failed â€” check connection', 'error');
    document.getElementById('delete-btn').disabled = false;
  }
});

document.querySelectorAll('.modal-overlay').forEach(ov =>
  ov.addEventListener('click', e => { if (e.target === ov) closeAll(); })
);

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(async () => {
  try {
    document.getElementById('loading-msg').textContent = 'Connecting to Smartsheetâ€¦';
    await loadSheet();
    populateOfficeSelect();
    renderLegend();
    renderView();
    hideLoading();
  } catch (err) {
    console.error(err);
    document.getElementById('loading-msg').textContent = 'Failed to connect. Please refresh and try again.';
  }
})();
</script>
</body>
</html>
